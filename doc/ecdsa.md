# ECDSA による署名について

## ECDSA is 何

- 楕円曲線DSAとも呼ばれる署名のアルゴリズム
- ブロックチェーンなどで使用される
  - ブロックチェーンではトランザクションに対して以下の3つの要素が必要
    - 間違いなく送信者が生成したトランザクションであること（第三者によって生成された偽データではない）
    - トランザクション生成後、第三者によってデータが改ざんされていないか確認ができること
    - 送信者が生成したトランザクションであるということを誰もが証明できること

## 前提知識: 楕円曲線

- 以下のような方程式で楕円曲線を定義する。
  $$
  y^2=x^3+ax+b
  $$

- ビットコインやイーサリアムでは**secp256k1**曲線が用いられている。（*a=0, b=7*）
  $$
  y^2 = x^3 + 7
  $$
  ![graph](https://i2.wp.com/zoom-blc.com/wp-content/uploads/2018/05/ecdsa2.png?w=450&ssl=1)
  - この曲線上で**A+B**を計算したいときは以下のようにする。

    ![graph](https://i1.wp.com/zoom-blc.com/wp-content/uploads/2018/05/ecdsa3.png?w=450&ssl=1)

  - **点G**から**2G**を求めたい場合は以下のようにする。

    ![graph](https://i1.wp.com/zoom-blc.com/wp-content/uploads/2018/05/ecdsa4.png?w=450&ssl=1)

  - このような計算を、2G+G=3G, 3G+G=4G....とr回繰り返すことで**点rG=(x, y)**が得られ、この値**r**が秘密鍵となる。さらに、secp256kで定められたベースポイント**G(x, y)**から秘密鍵rを用いて算出された**rG(x, y)**が公開鍵になる。
    $$
    Gx = 0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179 \\
    Gy = 0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8
    $$

  - 自身の秘密鍵**r**からGを**r**回加算することにより簡単に共通鍵**rG**を求めることができる。

  - 逆に、共通鍵**rG**から値**r**を求めることは非常に困難である。

  - 実際の楕円曲線暗号では有限体上（ガロア体）で楕円曲線を考える。

    - **p**を素数として**p**の{0, 1, 2, ... , p-1}という**p**個の整数集合を用いて演算
    - つまり、整数を**p**で除算したときの余りの集合。
    - **p=<sub>16</sub>(0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f) = <sub>10</sub>(2^256-2^32-977)**

## ECDSAによる署名生成

1. **秘密鍵q**を生成

2. **秘密鍵q**より、ベースポイントGを使用し公開鍵を算出しそのx座標を**R**とする

3. トランザクションをRLPエンコードし、さらにKeccak256でハッシュ化した**値h**を生成

4. それらの値とベースポイントGの有限体の要素数**p**、送信者の秘密鍵**k**から**S**を計算する
   $$
   S=\frac{h+kR}{q}(\mod{p})
   $$

**S**と**R**がトランザクションとともにブロードキャストされる。

## ECDSAによる署名検証

1. 受け取ったトランザクションをRLPエンコードし、さらにKeccak256でハッシュ化した**値h**を生成

2. 受け取った**S**と**R**、送信者の**公開鍵K**、ベースポイント**G**とその有限体の要素数**p**から**Q**を生成
   $$
   Q = \frac{hG}{S} + \frac{RK}{S}(\mod{p})
   $$

3. ***Q=R***となる場合に正当な署名であると証明ができる

## 参考文献

- [https://zoom-blc.com/what-is-ecdsa](https://zoom-blc.com/what-is-ecdsa)